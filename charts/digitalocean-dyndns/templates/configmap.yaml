apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-updater" (include "digitalocean-dyndns.fullname" .) }}
  labels:
    {{- include "digitalocean-dyndns.labels" . | nindent 4 }}
data:
  updater.sh: |
    #!/bin/sh
    # fetch public IP
    IP=$(curl -s "${IP_SERVICE:-ifconfig.co}" | grep -Eo '[0-9\.]+')

    # fetch record ID associated with the domain
    RECORDS=$(curl -s -X GET -H "Content-Type: application/json" -H "Authorization: Bearer ${DO_TOKEN}" "https://api.digitalocean.com/v2/domains/${DOMAIN}/records")
    RECORD_ID=$(echo "${RECORDS}" | jq ".domain_records[] | select(.type == \"A\" and .name == \"$NAME\") | .id")

    # send request to update DNS record
    curl -s -X PUT \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer ${DO_TOKEN}" \
      -d "{\"type\": \"A\", \"name\": \"${NAME}\", \"data\": \"${IP}\"}" \
      "https://api.digitalocean.com/v2/domains/${DOMAIN}/records/${RECORD_ID}"

    # output info
    echo "${NAME}.${DOMAIN} -> ${IP}"
